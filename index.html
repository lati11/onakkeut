<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë‚šë - ì›¹ ë²„ì „</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/dist/buffer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconv-lite@0.6.3/dist/iconv-lite.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .drop-zone-active { border-style: dashed !important; border-color: #3b82f6 !important; background-color: #eff6ff !important; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm text-center">
        <div class="w-full text-left mb-4">
            <h1 class="text-xl font-bold text-gray-700">ì˜¤ë‚šë ğŸ£</h1>
        </div>
        <h2 class="text-2xl font-bold mb-8 text-gray-700">ì˜¤ëŠ˜ì˜ ì§ì—…ì€?</h2>
        <div id="job-buttons" class="space-y-4"></div>
    </div>

    <div id="analyzer-modal" class="fixed inset-0 modal-bg items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">ë¶„ì„ê¸°</h2>
            </div>
            <div id="drop-zone" class="p-6 overflow-y-auto flex-grow text-center border-2 border-transparent transition-colors duration-200">
                <div class="mb-6 max-w-md mx-auto">
                    <label class="block text-gray-700 text-sm font-bold mb-2 text-left" for="log-file-input">
                        ë¡œê·¸ íŒŒì¼ ì„ íƒ (.log / .gz) - ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥
                    </label>
                    <label class="w-full flex items-center px-4 py-2 bg-white text-blue-500 rounded-lg shadow-md tracking-wide uppercase border border-blue-500 cursor-pointer hover:bg-blue-500 hover:text-white">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4 4-4-4h3V3h2v8z" />
                        </svg>
                        <span id="file-chosen" class="truncate">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”</span>
                        <input type='file' id="log-file-input" class="hidden" accept=".log,.gz" multiple/>
                    </label>
                </div>
                <div id="loading-spinner" class="text-center my-8 hidden">
                    <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-600">ë¡œê·¸ íŒŒì¼ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                    <p id="analysis-status" class="mt-1 text-sm text-gray-500"></p>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t text-right space-x-2">
                <button id="analyze-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">í™•ì¸</button>
                <button id="close-modal-button" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const JOB_DATA = { "ì–´ë¶€": { "title": "ì˜¤ë‚šë (ì–´ë¶€)", "menu_icon": "menuicon1.png", "items": [ "ë¬¼ì˜ ì›ì†Œ ê°€ë£¨", "ë¬¼ì˜ ì›ì†Œ ì¡°ê°", "ë¬¼ì˜ ì›ì†Œ ì •ìˆ˜", "ì§„ì£¼", "í–‰ìš´ì˜ í¸ì§€", "í•´ì ì˜ ë³´ë¬¼ìƒì", "ë§ˆë…€ì˜ ëˆˆë¬¼", "ìš©ì™•ì˜ ì™•ê´€", "ì‹¤ì¢…ëœ ì ìˆ˜ë¶€ í—¬ë©§", "ê³ ëŒ€ ë¬¼ì˜ ì˜í˜¼ì„", "ë¬¼ì˜ ì •ë ¹ì˜ ìœ ë¦¬êµ¬ë‘", "ê³ ê¸‰ ì–´ë¶€ ìƒì" ] }, "ê´‘ë¶€": { "title": "ì˜¤ê´‘ë (ê´‘ë¶€)", "menu_icon": "menuicon2.png", "items": [ "ë•…ì˜ ì›ì†Œ ê°€ë£¨", "ë•…ì˜ ì›ì†Œ ì¡°ê°", "ë•…ì˜ ì›ì†Œ ì •ìˆ˜", "ê°€ë„·", "ì•„ì¿ ì•„ë§ˆë¦°", "í† íŒŒì¦ˆ", "í˜ë¦¬ë„íŠ¸", "ì•”ëª¨ë‚˜ì´íŠ¸ í™”ì„", "ê±°ë¯¸ í™”ì„", "ë¬¼ê³ ê¸° í™”ì„", "ê³µë£¡ì•Œ í™”ì„", "ì†”ë¼ì´íŠ¸ ì›ì„", "ì‹¤ì¢…ëœ ê´‘ë¶€ì˜ í‘œë³¸ìƒ˜í”Œ", "ê³ ëŒ€ì˜ í”¼ë¼ë¯¸ë“œ íë¸Œ", "ëŒ€ì§€ì˜ ì •ë ¹ì˜ í˜¸ë°•í™”ì„", "ê³ ê¸‰ ê´‘ë¶€ ìƒì" ] }, "ë†ë¶€": { "title": "ì˜¤ë†ë (ë†ë¶€)", "menu_icon": "menuicon3.png", "items": [ "ë¶ˆì˜ ì›ì†Œ ê°€ë£¨", "ë¶ˆì˜ ì›ì†Œ ì¡°ê°", "ë¶ˆì˜ ì›ì†Œ ì •ìˆ˜", "ì• ë²Œë ˆ", "ë¬´ë‹¹ë²Œë ˆ", "ë©”ëšœê¸°", "ë”±ì •ë²Œë ˆ", "ë°€ ë²ˆë“¤", "ëŒ€ë‚˜ë¬´ ë²ˆë“¤", "ë¹„íŠ¸ ë²ˆë“¤", "ê°ì ë²ˆë“¤", "ê°ˆìƒ‰ ë²„ì„¯ ë²ˆë“¤", "ë¹¨ê°„ ë²„ì„¯ ë²ˆë“¤", "ì„ ì¸ì¥ ë²ˆë“¤", "ë‹¹ê·¼ ë²ˆë“¤", "í›„ë ´í™” ë²ˆë“¤", "ì½”ì½”ì•„ì½© ë²ˆë“¤", "ë„¤ë”ì™€íŠ¸ ë²ˆë“¤", "ì‚¬íƒ•ìˆ˜ìˆ˜ ë²ˆë“¤", "ì¼ˆí”„ ë²ˆë“¤", "ìˆ˜ë°• ì¡°ê° ë²ˆë“¤", "ë‹¬ì½¤í•œ ì—´ë§¤ ë²ˆë“¤", "ê°œëŸ‰ëœ ëª©í™”ì†œ", "ì‹¤ì¢…ëœ ë†ë¶€ì˜ ë•…ë¬¸ì„œ", "ê³ ëŒ€ì‹ë¬¼ì˜ ëª¨ì¢…", "ë¶ˆì˜ ì •ë ¹ì˜ ê½ƒ í™”ê´€", "ê³ ê¸‰ ë†ë¶€ ìƒì" ] }, "ë‚˜ë¬´ê¾¼": { "title": "ì˜¤ë‚˜ë (ë‚˜ë¬´ê¾¼)", "menu_icon": "menuicon4.png", "items": [ "ë°”ëŒì˜ ì›ì†Œ ê°€ë£¨", "ë°”ëŒì˜ ì›ì†Œ ì¡°ê°", "ë°”ëŒì˜ ì›ì†Œ ì •ìˆ˜", "ë‚˜ë¬´ê»ì§ˆ", "ê³ ëª©ë‚˜ë¬´ ìˆ˜ì•¡", "ë§¨ë“œë ˆì´í¬", "ë°”ì˜¤ë°¥ë‚˜ë¬´ ë¿Œë¦¬", "ì†¡ì´ë²„ì„¯", "ë¶ˆë¡œì´ˆ", "ì„¤ì‚¼", "í™©ê¸ˆë²„ì„¯", "ì›ì‹œë¶€ì¡± ê°€ë©´", "ì‹¤ì¢…ëœ ë‚˜ë¬´ê¾¼ì˜ ì¥ê°‘", "ê³ ëŒ€ ì •ë ¹ì˜ ë©”ì•„ë¦¬", "ë‚˜ë¬´ì˜ ì •ë ¹ì˜ ì—°ê½ƒ ì°»ì”", "ê³ ê¸‰ ë‚˜ë¬´ê¾¼ ìƒì" ] }, "ì‚¬ëƒ¥ê¾¼": { "title": "ì˜¤ëƒ¥ë (ì‚¬ëƒ¥ê¾¼)", "menu_icon": "menuicon5.png", "items": [ "ì˜í˜¼ì˜ ì›ì†Œ ê°€ë£¨", "ì˜í˜¼ì˜ ì›ì†Œ ì¡°ê°", "ì˜í˜¼ì˜ ì›ì†Œ ì •ìˆ˜", "ì§ìŠ¹ì˜ ì†¡ê³³ë‹ˆ", "ì§ìŠ¹ì˜ ê°€ì£½", "ì§ìŠ¹ì˜ ê¼¬ë¦¬", "ë…ì¹¨", "ìš©ì˜ í”¼", "ëŒ€ì§€ì˜ ê²°ì •ì²´", "ë¶€ë“œëŸ¬ìš´ ê¹ƒí„¸", "ë¶€ë“œëŸ¬ìš´ í„¸", "ë²„ì„¯ ê³ ê¸°", "ë°”ëŒì˜ ê²°ì •ì²´", "ë¬¼ë°©ìš¸ì˜ ë³„", "ê³µí—ˆì˜ íŒŒë™", "ëŒê³ ë˜ì˜ ë§ˆìŒ", "ë¬¼ì˜ ê²°ì •ì²´", "ë„˜ì‹¤ê±°ë¦¬ëŠ” ë¶ˆê½ƒ", "ê°€ìŠ¤íŠ¸ì˜ íŒŒí¸", "ë¶ˆì˜ ê²°ì •ì²´", "ë”ëŸ¬ìš´ ì²œ", "ì—”ë” ì§„ì£¼ ê°€ë£¨", "ì‚¬ì•…í•œ ê¸°ìš´", "ìˆ˜ìƒí•œ ì£¼ë¨¸ë‹ˆ", "íƒ€ë½í•œ ì›”ê³„ìˆ˜ ì", "íƒ€ë½í•œ ìš”ì •ì˜ ê°€ë£¨", "ì–´ë‘ ì˜ ê²°ì •ì²´", "ë¯¸ìŠ¤í‹± ì½”ì–´", "ê°ˆë¹„ë¼ˆ", "ìš”ì •ì˜ ê°€ë£¨", "ë¹›ì˜ ê²°ì •ì²´", "ì‹ ë¹„í•œ ë™ë¬¼ ê°€ì£½", "ì‹¤ì¢…ëœ ì‚¬ëƒ¥ê¾¼ ê³ ê¸€", "ê³ ëŒ€ ë§˜ëª¨ìŠ¤ ë¿”", "ì–´ë‘ ì˜ ì •ë ¹ì˜ ë¶€ëŸ¬ì§„ ìŠ¤íƒœí”„", "ê³ ê¸‰ ì‚¬ëƒ¥ê¾¼ ìƒì", "ì‹¤", "ì•ˆì¥", "ê³ ì‚¬ë¦¬", "ìŠ¬ë¼ì„ë³¼", "ê¹ƒí„¸", "ì í†  ë©ì´", "ë§ˆë¥¸ ë¤ë¶ˆ", "ë°œê´‘ì„ ê°€ë£¨", "ë ˆë“œìŠ¤í†¤ ê°€ë£¨", "ë¼ˆë‹¤ê·€", "í™”ì•½", "ë°”ë‹¤ì˜ ì‹¬ì¥", "ì¸ê°‘", "ì „ë‹¬ì²´", "í”„ë¦¬ì¦ˆë¨¸ë¦° ìˆ˜ì •", "í”„ë¦¬ì¦ˆë¨¸ë¦° ì¡°ê°", "ë¨¹ë¬¼ ì£¼ë¨¸ë‹ˆ", "ë°œê´‘ ë¨¹ë¬¼ ì£¼ë¨¸ë‹ˆ", "ì –ì€ ìŠ¤í€ì§€", "ê°€ì£½", "í™”ì—¼êµ¬", "ìœ„ë” ì¥ë¯¸", "ë¸”ë ˆì´ì¦ˆ ë§‰ëŒ€ê¸°", "ë²Œë ˆ ë¨¹ì€ ëŒ", "ì—”ë” ì§„ì£¼", "ì…œì»¤ ê»ë°ê¸°", "ê±°ë¯¸ì¤„" ] } };

    let currentJob = null;
    let logFiles = [];

    const modal = document.getElementById('analyzer-modal');
    const analyzeButton = document.getElementById('analyze-button');
    const loadingSpinner = document.getElementById('loading-spinner');
    const fileInput = document.getElementById('log-file-input');
    const fileChosenLabel = document.getElementById('file-chosen');
    const modalTitle = document.getElementById('modal-title');
    const dropZone = document.getElementById('drop-zone');
    
    function createMainMenu() { const jobButtonsContainer = document.getElementById('job-buttons'); const jobOrder = ["ì–´ë¶€", "ê´‘ë¶€", "ë†ë¶€", "ë‚˜ë¬´ê¾¼", "ì‚¬ëƒ¥ê¾¼"]; jobOrder.forEach(jobName => { const data = JOB_DATA[jobName]; const btn = document.createElement('button'); btn.className = "w-full flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-colors duration-200"; btn.innerHTML = `<img src="images/${data.menu_icon}" alt="${jobName} ì•„ì´ì½˜" class="w-6 h-6 mr-3 rounded"><span>${data.title.split(' ')[0]}</span>`; btn.onclick = () => openModal(jobName); jobButtonsContainer.appendChild(btn); }); }
    function openModal(jobName) { currentJob = jobName; modalTitle.textContent = JOB_DATA[jobName].title; modal.classList.remove('hidden'); modal.classList.add('flex'); resetFileInput(); }
    function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
    function resetFileInput() { fileInput.value = ''; logFiles = []; fileChosenLabel.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”'; loadingSpinner.classList.add('hidden'); }

    function handleFiles(files) {
        logFiles = Array.from(files);
        if (logFiles.length > 1) {
            fileChosenLabel.textContent = `${logFiles.length}ê°œì˜ íŒŒì¼ì´ ì„ íƒë¨`;
        } else if (logFiles.length === 1) {
            fileChosenLabel.textContent = logFiles[0].name;
        } else {
            fileChosenLabel.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”';
        }
    }

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drop-zone-active'); });
    ['dragleave', 'dragend', 'drop'].forEach(type => { dropZone.addEventListener(type, (e) => { e.preventDefault(); dropZone.classList.remove('drop-zone-active'); }); });
    dropZone.addEventListener('drop', (e) => { if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; handleFiles(e.dataTransfer.files); } });

    async function processAndCombineFiles(files) {
        const fileReadPromises = files.map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const dateRegex = /(\d{4}-\d{2}-\d{2})/;
                        const match = file.name.match(dateRegex);
                        let logDate;
                        if (match) {
                            logDate = match[1];
                        } else {
                            const today = new Date();
                            logDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        }

                        const buffer = new Uint8Array(event.target.result);
                        let dataToDecode = buffer;

                        if (file.name.endsWith('.gz')) {
                            dataToDecode = pako.inflate(buffer);
                        }
                        
                        let text;
                        try {
                            text = new TextDecoder('utf-8', { fatal: true }).decode(dataToDecode);
                        } catch (e) {
                            text = iconv.decode(Buffer.from(dataToDecode), 'cp949');
                        }
                        
                        resolve({ content: text, date: logDate });

                    } catch (error) {
                        reject(new Error(`'${file.name}' íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`));
                    }
                };
                reader.onerror = (e) => reject(new Error(`'${file.name}' íŒŒì¼ ì½ê¸° ì‹¤íŒ¨`));
                reader.readAsArrayBuffer(file);
            });
        });
        return Promise.all(fileReadPromises);
    }

    async function analyzeLogs(logChunks, itemList) {
        const totalItemCounts = {};
        itemList.forEach(item => totalItemCounts[item] = 0);
        const sessions = [];
        let currentSession = null;
        let lastTime = null;
        let coinsEarned = 0.0, coinsSpent = 0.0, crabCount = 0, minigameCount = 0;

        const acquisitionPattern = /\[CHAT\].*?(?:\?\s*)?(.*?)\s*x\s*(\d+)\s*ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤/;
        const coinEarnedPattern = /\[ë² ì–´ê²½ì œ\] \+ ([\d,]+\.?[\d]*)/;
        const coinSpentPattern = /\[ë² ì–´ê²½ì œ\] ([\d,]+\.?[\d]*) ì½”ì¸ ë¥¼ ì†Œëª¨í–ˆìŠµë‹ˆë‹¤!/;
        const crabPattern = /\[CHAT\].*ê²Œë¥¼ ë‚šì•˜ìŠµë‹ˆë‹¤\./;
        const minigamePattern = /\[CHAT\] ë¯¸ë‹ˆê²Œì„ì„ ì„±ê³µì ìœ¼ë¡œ í†µê³¼í•˜ì—¬ ë³´ìƒì„ íšë“í•©ë‹ˆë‹¤!/;

        for (const chunk of logChunks) {
            const logs = chunk.content.split(/\r?\n/);
            for (let i = 0; i < logs.length; i++) {
                const currentLine = logs[i];

                let earnedMatch = currentLine.match(coinEarnedPattern);
                if (earnedMatch) coinsEarned += parseFloat(earnedMatch[1].replace(/,/g, ''));
                if (crabPattern.test(currentLine)) crabCount++;
                if (minigamePattern.test(currentLine)) minigameCount++;
                let spentMatch = currentLine.match(coinSpentPattern);
                if (spentMatch) coinsSpent += parseFloat(spentMatch[1].replace(/,/g, ''));
                
                let itemMatch = currentLine.match(acquisitionPattern);
                if (!itemMatch) continue;

                let foundRankingPoints = false;
                for (let j = 1; j < 5; j++) {
                    if ((i + j) < logs.length && logs[i + j].includes("ìƒí™œë­í‚¹ í¬ì¸íŠ¸")) {
                        foundRankingPoints = true;
                        break;
                    }
                }

                if (foundRankingPoints) {
                    const timeMatch = currentLine.match(/^\[(\d{2}:\d{2}:\d{2})\]/);
                    if (!timeMatch) continue;
                    
                    const timestamp = new Date(`${chunk.date}T${timeMatch[1]}`);
                    if (isNaN(timestamp.getTime())) continue;

                    if (currentSession === null) {
                        currentSession = { start: timestamp, end: timestamp, items: {} };
                        sessions.push(currentSession);
                    } else if (lastTime && (timestamp.getTime() - lastTime.getTime()) / 1000 > 300) {
                        currentSession = { start: timestamp, end: timestamp, items: {} };
                        sessions.push(currentSession);
                    }
                    currentSession.end = timestamp;
                    lastTime = timestamp;

                    const rawItem = itemMatch[1].trim();
                    const count = parseInt(itemMatch[2], 10);
                    const itemName = rawItem.replace(/^[^ê°€-í£a-zA-Z0-9]*/, "");
                    if (itemList.includes(itemName)) {
                        totalItemCounts[itemName] = (totalItemCounts[itemName] || 0) + count;
                        currentSession.items[itemName] = (currentSession.items[itemName] || 0) + count;
                    }
                }
            }
        }
        return { totalItemCounts, sessions, coinsEarned, coinsSpent, crabCount, minigameCount };
    }
    
    analyzeButton.addEventListener('click', async () => {
        if (logFiles.length === 0 || !currentJob) {
            alert('ë¡œê·¸ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        loadingSpinner.classList.remove('hidden');
        document.getElementById('analysis-status').textContent = 'ë¶„ì„ì´ ì™„ë£Œë˜ë©´ ìƒˆ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤.';
        try {
            const logChunks = await processAndCombineFiles(logFiles);
            const results = await analyzeLogs(logChunks, JOB_DATA[currentJob].items);
            
            sessionStorage.setItem('analysisResult', JSON.stringify(results));
            sessionStorage.setItem('currentJob', currentJob);
            window.open('results.html', '_blank');
            closeModal();
        } catch (error) {
            console.error(error);
            alert(`ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
        } finally {
            loadingSpinner.classList.add('hidden');
            document.getElementById('analysis-status').textContent = '';
        }
    });
    
    createMainMenu();
    document.getElementById('close-modal-button').addEventListener('click', closeModal);
});
</script>
</body>
</html>
